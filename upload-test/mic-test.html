<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulate call ‚Üí Gemini / Vertex</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; max-width: 560px; margin: 0 auto; padding: 1.5rem; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; color: #fff; }
    .sub { font-size: 0.8rem; color: #707070; margin-bottom: 1rem; }
    label { display: block; font-size: 0.85rem; margin-bottom: 0.25rem; color: #b0b0b0; }
    input[type="text"] { width: 100%; padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; margin-bottom: 1rem; }
    .box { background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    button { background: #2a7de0; color: #fff; border: none; cursor: pointer; font-weight: 500; padding: 0.6rem 1.2rem; border-radius: 6px; font-size: 0.95rem; }
    button:hover { background: #1e6bc7; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.danger { background: #c03030; }
    button.danger:hover { background: #a02020; }
    button.secondary { background: #505060; }
    button.secondary:hover { background: #404050; }
    button.secondary.muted { background: #606050; color: #c0c0a0; }
    button.secondary.muted:hover { background: #505040; }
    button.green { background: #208030; }
    button.green:hover { background: #186028; }
    .result { white-space: pre-wrap; word-break: break-word; font-size: 0.9rem; margin-top: 0.5rem; }
    .result.empty { color: #606060; font-style: italic; }
    .error { color: #e06060; }
    .success { color: #60c060; }
    .row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-top: 0.5rem; }
    .radio { display: inline-flex; align-items: center; gap: 0.35rem; margin-right: 1rem; font-weight: normal; cursor: pointer; }
    a { color: #6ab; }
    .call-screen { text-align: center; padding: 1.5rem; }
    .call-screen .ringing { font-size: 1.1rem; color: #a0a0a0; margin-bottom: 1rem; }
    .call-screen .btns { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    .transcript { max-height: 240px; overflow-y: auto; font-size: 0.85rem; }
    .transcript .turn { margin-bottom: 0.5rem; }
    .transcript .agent { color: #6ab; }
    .transcript .user { color: #b0b0b0; }
  </style>
</head>
<body>
  <h1>Simulate call ‚Üí Gemini / Vertex</h1>
  <p class="sub">Pretend you‚Äôre receiving a call. Answer ‚Üí Gemini speaks first (greeting), then you can talk back and forth. Uses your mic + browser TTS.</p>

  <p class="sub" style="margin-bottom: 0.5rem;"><strong>Startup:</strong> In <code>cheese</code>: <code>python -m uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000</code>. In <code>upload-test</code>: <code>npm start</code>. Open <a href="http://localhost:3001/mic-test.html">localhost:3001/mic-test.html</a>.</p>

  <div class="box">
    <label for="apiUrl">API base URL</label>
    <input type="text" id="apiUrl" value="http://localhost:8000" />
    <label style="margin-top: 0.75rem;">Backend</label>
    <div class="row" style="margin-top: 0.25rem;">
      <label class="radio"><input type="radio" name="backend" value="gemini" checked /> Gemini API (key)</label>
      <label class="radio"><input type="radio" name="backend" value="vertex" /> Vertex AI (GCP)</label>
    </div>
  </div>

  <div id="preCall" class="box">
    <p class="sub">Click to simulate an incoming call. You‚Äôll see ‚ÄúAnswer‚Äù / ‚ÄúDecline‚Äù; after Answer, the AI will greet you first, then you can speak.</p>
    <button type="button" id="btnIncoming" class="green">üìû Incoming call</button>
  </div>

  <div id="incomingCall" class="box call-screen" style="display:none;">
    <p class="ringing">Incoming call‚Ä¶</p>
    <div class="btns">
      <button type="button" id="btnAnswer" class="green">Answer</button>
      <button type="button" id="btnDecline" class="danger">Decline</button>
    </div>
  </div>

  <div id="inCall" class="box" style="display:none;">
    <p id="status" class="result empty">Connecting‚Ä¶</p>
    <div class="row">
      <button type="button" id="btnMic" class="secondary" title="Mic on/off (Gemini does not receive when off)">Mic off</button>
      <button type="button" id="btnEnd" class="danger">End call</button>
    </div>
    <p class="sub" style="margin-top: 0.5rem;" id="micHint">Mic on. Talk anytime‚ÄîGemini will stop speaking when you start.</p>
    <div style="margin-top: 1rem;">
      <strong>Transcript</strong>
      <div id="transcript" class="transcript result empty">‚Äî</div>
    </div>
  </div>

  <div id="afterCall" class="box" style="display:none;">
    <strong>Last call ‚Äî Doctor summary</strong>
    <p class="sub">Parsed from transcript for the doctor (includes original complaint context).</p>
    <div id="doctorSummary" class="result empty">‚Äî</div>
    <button type="button" id="btnNewCall" class="green" style="margin-top: 0.5rem;">Start new call</button>
  </div>

  <p class="sub"><a href="index.html">‚Üê Back to Upload & parse test</a></p>

  <script>
    const apiUrl = () => document.getElementById('apiUrl').value.replace(/\/$/, '');
    const $ = (id) => document.getElementById(id);

    const EXAMPLE_PATIENT_NAME = "Abhinav Jain";
    const EXAMPLE_CONSULTATION_SUMMARY = "Patient presented with back pain and was prescribed medication. This is a follow-up call 2 days post-visit to check on recovery and medication adherence.";
    const CALL_SYSTEM_PROMPT = [
      "You are Emily, a friendly and empathetic AI medical assistant calling on behalf of the clinic.",
      `You are speaking to ${EXAMPLE_PATIENT_NAME}.`,
      `The primary reason for the recent consultation was: ${EXAMPLE_CONSULTATION_SUMMARY}`,
      "Your core task: check how the patient is feeling today and ask if they are experiencing any new symptoms or complications related to their recent visit.",
      "Call flow ‚Äî POSITIVE: If they say doing well, feeling good, no problems: thank them, ask 'Is there anything else the hospital can help you with?' If they say no/nothing else: thank them for their time and say Goodbye.",
      "Call flow ‚Äî WHEN THEY REPORT ANYTHING NOT FULLY POSITIVE (symptoms, pain, still bad, worse): Acknowledge and act as if noting everything they say. If they say 'very painful', 'still bad', 'really bad': ask how bad (e.g. scale 1‚Äì10) or for a bit more detail. When they say 'that's it', 'that's all', 'nothing else', or indicate done: thank them for sharing, then say Goodbye. Do not give medical advice; for severe symptoms advise emergency care or contact clinic.",
      "Constraint 1: Keep responses extremely brief. 1 to 2 short sentences. No markdown, emojis, or bullet points.",
      "Constraint 2: End the call with a clear Goodbye when done."
    ].join("\n");

    let history = [];
    let inCall = false;

    function setStatus(msg, isError) {
      const el = $('status');
      el.textContent = msg;
      el.className = 'result ' + (isError ? 'error' : '');
    }

    function appendTranscript(role, text) {
      const el = $('transcript');
      if (el.classList.contains('empty')) el.textContent = '';
      el.classList.remove('empty');
      const div = document.createElement('div');
      div.className = 'turn ' + (role === 'model' ? 'agent' : 'user');
      div.textContent = (role === 'model' ? 'Gemini: ' : 'You: ') + text;
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
    }

    let ttsPlaying = false;
    let ttsCooldownUntil = 0;
    const TTS_COOLDOWN_MS = 1500;

    function speak(text, onEnd) {
      if (!text) return null;
      speechSynthesis.cancel();
      ttsPlaying = true;
      ttsCooldownUntil = 0;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.95;
      u.onend = () => {
        ttsPlaying = false;
        ttsCooldownUntil = Date.now() + TTS_COOLDOWN_MS;
        if (onEnd) onEnd();
      };
      speechSynthesis.speak(u);
      return u;
    }

    function stopSpeaking() {
      ttsPlaying = false;
      ttsCooldownUntil = 0;
      speechSynthesis.cancel();
    }

    function isIgnoringMic() {
      return ttsPlaying || Date.now() < ttsCooldownUntil;
    }

    function useVertex() {
      return document.querySelector('input[name="backend"]:checked')?.value === 'vertex';
    }

    async function sendToGemini(message, systemPrompt, addToHistory) {
      const body = {
        message,
        system_prompt: systemPrompt || undefined,
        history: addToHistory ? history : undefined,
      };
      const endpoint = useVertex() ? '/test/chat-vertex' : '/test/chat';
      const res = await fetch(apiUrl() + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.detail || res.statusText || res.status);
      const reply = data.reply || '';
      if (addToHistory) {
        history.push({ role: 'user', text: message });
        history.push({ role: 'model', text: reply });
      }
      return reply;
    }

    $('btnIncoming').onclick = () => {
      $('preCall').style.display = 'none';
      $('incomingCall').style.display = 'block';
    };

    $('btnDecline').onclick = () => {
      $('incomingCall').style.display = 'none';
      $('preCall').style.display = 'block';
    };

    $('btnAnswer').onclick = async () => {
      $('incomingCall').style.display = 'none';
      $('inCall').style.display = 'block';
      inCall = true;
      micOn = true;
      updateMicButton();
      history = [];
      setStatus('Starting call‚Ä¶ Gemini will speak first.');
      try {
        const greeting = await sendToGemini(
          `Start the call. Say only your opening greeting: greet ${EXAMPLE_PATIENT_NAME} by name and say you're calling from the clinic to see how he's doing after his visit for back pain (2-day follow-up). One short paragraph, then stop.`,
          CALL_SYSTEM_PROMPT,
          false
        );
        appendTranscript('model', greeting);
        if (greeting) speak(greeting, () => startListening()); else startListening();
        setStatus('Listening. Talk anytime‚ÄîGemini stops when you speak.');
      } catch (e) {
        const errMsg = (e && e.message) || String(e);
        setStatus('Error: ' + errMsg, true);
        appendTranscript('model', 'Error: ' + errMsg);
        startListening();
      }
    };

    let recognition = null;
    let processing = false;
    let micOn = true;
    const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;

    function updateMicButton() {
      const btn = $('btnMic');
      const hint = $('micHint');
      if (micOn) {
        btn.textContent = 'Mic off';
        btn.classList.remove('muted');
        if (hint) hint.textContent = 'Mic on. Talk anytime‚ÄîGemini will stop speaking when you start.';
      } else {
        btn.textContent = 'Mic on';
        btn.classList.add('muted');
        if (hint) hint.textContent = 'Mic off. Gemini cannot hear you.';
      }
    }

    function startListening() {
      if (!SpeechRecognitionAPI || !inCall || !micOn) return;
      recognition = new SpeechRecognitionAPI();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';
      recognition.onresult = (e) => {
        if (!micOn || isIgnoringMic()) return;
        const res = e.results[e.resultIndex];
        const transcript = (res[0] && res[0].transcript) ? res[0].transcript : '';
        if (!transcript.trim()) return;
        if (!res.isFinal) {
          stopSpeaking();
          return;
        }
        if (processing || transcript.trim().split(/\s+/).length < 2) return;
        processing = true;
        userSaid(transcript.trim()).finally(() => { processing = false; });
      };
      recognition.onerror = (e) => {
        if (e.error !== 'no-speech') setStatus('Speech error: ' + (e.error || 'unknown'), true);
      };
      recognition.start();
      setStatus('Listening. Talk anytime‚ÄîGemini stops when you speak.');
    }

    function stopListening() {
      if (recognition) { try { recognition.stop(); } catch (_) {} recognition = null; }
    }

    $('btnMic').onclick = () => {
      micOn = !micOn;
      updateMicButton();
      if (micOn) {
        startListening();
      } else {
        stopListening();
        setStatus('Mic off. Gemini cannot hear you.');
      }
    };

    async function userSaid(text) {
      if (!text || !inCall) return;
      stopSpeaking();
      appendTranscript('user', text);
      setStatus('Thinking‚Ä¶');
      try {
        const reply = await sendToGemini(text.trim(), CALL_SYSTEM_PROMPT, true);
        appendTranscript('model', reply);
        speak(reply);
        setStatus('Listening. Talk anytime‚ÄîGemini stops when you speak.');
      } catch (e) {
        setStatus('Error: ' + (e.message || e), true);
      }
    }

    function buildTranscriptText() {
      const parts = [];
      for (const t of history) {
        const label = t.role === 'user' ? 'Patient' : 'Emily';
        parts.push(label + ': ' + (t.text || '').trim());
      }
      return parts.join('\n');
    }

    $('btnEnd').onclick = async () => {
      stopSpeaking();
      stopListening();
      inCall = false;
      $('inCall').style.display = 'none';
      const transcriptText = buildTranscriptText();
      if (transcriptText.trim()) {
        $('doctorSummary').textContent = 'Parsing transcript‚Ä¶';
        $('doctorSummary').className = 'result';
        $('afterCall').style.display = 'block';
        try {
          const res = await fetch(apiUrl() + '/test/parse-transcript', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              transcript: transcriptText,
              patient_name: EXAMPLE_PATIENT_NAME,
              consultation_summary: EXAMPLE_CONSULTATION_SUMMARY,
              consultation_date: '2 days ago',
              use_vertex: useVertex()
            })
          });
          const data = await res.json().catch(() => ({}));
          if (res.ok && data.doctor_summary) {
            $('doctorSummary').textContent = data.doctor_summary;
            $('doctorSummary').classList.add('success');
          } else {
            $('doctorSummary').textContent = data.detail || res.statusText || 'Failed to parse';
            $('doctorSummary').classList.add('error');
          }
        } catch (e) {
          $('doctorSummary').textContent = 'Error: ' + (e.message || e);
          $('doctorSummary').classList.add('error');
        }
      } else {
        $('preCall').style.display = 'block';
      }
    };

    $('btnNewCall').onclick = () => {
      $('afterCall').style.display = 'none';
      $('doctorSummary').textContent = '‚Äî';
      $('doctorSummary').className = 'result empty';
      $('preCall').style.display = 'block';
    };
  </script>
</body>
</html>
